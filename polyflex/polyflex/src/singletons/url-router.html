<link rel="import" href="../behaviors/CoreBehavior.html" />
<link rel="import" href="../behaviors/EventBehavior.html" />

<dom-module id="url-router">

	<script>
		(function (window, Channel) {

			"use strict";

			var polyflex = window.polyflex = window.polyflex || {};
			var behaviors = polyflex.behaviors = polyflex.behaviors || {};
			var Route = polyflex.Route;
			var routes = polyflex.routes;
			var _routes = polyflex._routes;

			var page = window.page;


			Polymer({
				is: "url-router",
				behaviors: [behaviors.CoreBehavior, behaviors.EventBehavior],
				properties: {
					base: {
						type: String,
						observer: "setBase"
					}
				},
				setBase: function (newValue) {
					if (newValue) {
						page.base(newValue);
						this.log("Setting base url to: " + newValue);
					}
				},
				created: function () {
					this.onMessage({
						channel: Channel.ROUTE_ENTER,
						route: Route.ROUTE_NOT_FOUND,
						callback: function (context) {
							console.log("no route found");
						}
					});
					this.addRoute(Route.ROUTE_NOT_FOUND);
				},
				detached: function () {
					page.stop();
					this.log("Router stopped.");
				},
				addRoute: function (route) {
					if(!route){
						throw "You cant add route: " + route;
					}
					
					var rt = route;
					if(rt && rt.indexOf("Route") > -1){
						rt = Route[rt.replace("Route.", "")];
					} else {
						rt = Route[rt] || _routes[route];
					}
					
					if(!rt){
						throw "Please register route \"" + route + "\" before using it.";
					}

					var self = this;

					// Route can be registered with the router only once.
					// Once the route is registered, there is no back, 
					// at least for now.
					for (var i = 0; i < page.callbacks.length; ++i) {
						var routeObj = page.callbacks[i];
						if (routeObj.path === rt) {
							return;
						}
					}

					/**
					 * Registering route with url router.
					 * 
					 * @param {type} ctx
					 * @returns {undefined}
					 */
					page(rt, function (ctx) {
						// sends message that route is changed/entered.
						self.sendMessage({
							channel: Channel.ROUTE_ENTER,
							route: route,
							context: {context: ctx}
						});
					});

					/**
					 * Registering route with url router.
					 * 
					 * @param {type} ctx
					 * @returns {undefined}
					 */
//					page.exit(rt, function (ctx) {
//						// Send message that route is changed/exiting.
//						// Note that "route-exited" message is sent before
//						// "route-entered" message.
//						self.sendMessage({
//							channel: Channel.ROUTE_EXIT,
//							route: route,
//							context: {context: ctx}
//						});
//					});
					
					page.start({dispatch: false});
					
				},
				componentsReady: function(){
					this.webComponentsReady = true;
					page.start();
				}
			});

		})(window, window.polyflex.Channel);
	</script>
</dom-module>